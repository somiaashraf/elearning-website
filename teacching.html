<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة إنجازي التعليمية</title>
    <!-- استدعاء المكتبات اللازمة -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="pb-12 text-slate-900">

    <!-- الهيدر (رأس الصفحة) -->
    <header class="bg-white border-b sticky top-0 z-40 shadow-sm">
        <div class="container mx-auto px-4 py-4 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 id="display-title" class="text-2xl font-black text-teal-700">منصة إنجازي التعليمية</h1>
                <p id="display-subtitle" class="text-slate-500 text-sm">إدارة المحتوى والمتابعة الرقمية</p>
            </div>
            
            <div class="flex items-center gap-3">
                <div id="admin-login-area" class="flex gap-1 border rounded-lg p-1 bg-slate-50">
                    <input type="password" id="admin-pass-input" placeholder="كلمة الأدمن" class="bg-transparent px-2 py-1 text-xs outline-none w-24">
                    <button onclick="verifyAdmin()" class="bg-slate-800 text-white p-2 rounded-md hover:bg-slate-700">
                        <i data-lucide="settings" class="w-4 h-4 text-white"></i>
                    </button>
                </div>
                <button id="admin-btn" onclick="toggleModal('edit-modal')" class="hidden bg-teal-600 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2">
                    <i data-lucide="settings" class="w-4 h-4"></i> لوحة التحكم
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- قسم الإحصائيات -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center justify-center min-h-[250px]">
                <div class="relative w-44 h-44">
                    <canvas id="statsChart"></canvas>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="percent-text" class="text-3xl font-black text-teal-600">0%</span>
                        <span class="text-[10px] text-slate-400 font-bold">نسبة الإنجاز</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-6 flex items-center gap-2">
                    <i data-lucide="bar-chart-3" class="text-teal-600"></i> ملخص الأداء
                </h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-4 bg-teal-50 rounded-2xl">
                        <span class="text-teal-700 font-bold">تم إنجازه</span>
                        <span id="done-count" class="text-3xl font-black text-teal-700">0</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl">
                        <span class="text-slate-500 font-bold">متبقي لك</span>
                        <span id="remain-count" class="text-3xl font-black text-slate-700">0</span>
                    </div>
                </div>
            </div>

            <div class="bg-teal-700 p-6 rounded-2xl shadow-lg text-white relative overflow-hidden flex flex-col">
                <div class="relative z-10">
                    <h3 class="text-xl font-bold mb-2">مرحباً بك في رحلتك</h3>
                    <p class="text-teal-100 text-sm mb-6 leading-relaxed">تأكد من مشاهدة الفيديو المرفق بكل درس قبل التأشير عليه كمكتمل لضمان أفضل استفادة.</p>
                </div>
                <div class="mt-auto relative z-10 flex gap-2">
                    <button onclick="exportData()" class="flex-grow flex items-center justify-center gap-2 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-xs font-bold transition">
                        <i data-lucide="download" class="w-4 h-4"></i> تصدير البيانات
                    </button>
                    <button onclick="triggerImport()" class="flex-grow flex items-center justify-center gap-2 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-xs font-bold transition">
                        <i data-lucide="upload" class="w-4 h-4"></i> استيراد
                    </button>
                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                </div>
            </div>
        </div>

        <!-- تبديل الأسابيع -->
        <div id="weeks-tabs" class="flex gap-2 overflow-x-auto pb-4 mb-4"></div>

        <!-- قائمة الدروس -->
        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div id="lessons-list" class="divide-y divide-slate-100"></div>
        </div>
    </main>

    <!-- مودال تعديل الأدمن -->
    <div id="edit-modal" class="modal">
        <div class="bg-white w-full max-w-3xl rounded-3xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
            <div class="p-6 bg-slate-900 text-white flex justify-between items-center">
                <div class="flex items-center gap-3 font-bold">
                    <i data-lucide="settings"></i> لوحة تحكم الأدمن
                </div>
                <button onclick="toggleModal('edit-modal')" class="text-2xl">&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-grow space-y-6 custom-scrollbar">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 block mb-1">اسم المنصة</label>
                        <input type="text" id="edit-title" class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 ring-teal-500">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 block mb-1">وصف المنصة</label>
                        <input type="text" id="edit-subtitle" class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 ring-teal-500">
                    </div>
                </div>

                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black">تنظيم المنهج</h3>
                        <button onclick="addNewWeek()" class="bg-teal-100 text-teal-700 px-4 py-1 rounded-full text-xs font-bold hover:bg-teal-200">+ إضافة أسبوع</button>
                    </div>
                    <div id="admin-weeks-container" class="space-y-4"></div>
                </div>
            </div>

            <div class="p-4 bg-slate-50 border-t flex justify-end gap-2">
                <button onclick="toggleModal('edit-modal')" class="px-6 py-2 text-slate-500 font-bold">إلغاء</button>
                <button onclick="saveAdminChanges()" class="px-8 py-2 bg-teal-600 text-white rounded-xl font-bold shadow-lg shadow-teal-100">حفظ التغييرات</button>
            </div>
        </div>
    </div>

    <script>
        // البيانات الافتراضية
        let config = JSON.parse(localStorage.getItem('edu_pro_config')) || {
            title: "منصة إنجازي التعليمية",
            subtitle: "إدارة المحتوى والمتابعة الرقمية",
            adminPassword: "admin",
            weeks: [
                { id: 1, title: "الأسبوع الأول", days: [{ id: "d1", t: "مقدمة الدورة", videoUrl: "" }] }
            ]
        };

        let completed = JSON.parse(localStorage.getItem('edu_pro_done')) || [];
        let activeWeekId = config.weeks[0]?.id;
        let chart = null;

        // التشغيل الأولي
        function init() {
            lucide.createIcons();
            renderUI();
            updateStats();
        }

        function renderUI() {
            document.getElementById('display-title').innerText = config.title;
            document.getElementById('display-subtitle').innerText = config.subtitle;
            
            const tabsContainer = document.getElementById('weeks-tabs');
            tabsContainer.innerHTML = config.weeks.map(w => `
                <button onclick="switchWeek(${w.id})" class="px-6 py-2 rounded-xl font-bold text-sm whitespace-nowrap transition ${activeWeekId === w.id ? 'bg-teal-600 text-white shadow-lg' : 'bg-white text-slate-500 border hover:bg-slate-50'}">
                    ${w.title}
                </button>
            `).join('');

            renderLessons();
        }

        function renderLessons() {
            const week = config.weeks.find(w => w.id === activeWeekId);
            const list = document.getElementById('lessons-list');
            if (!week) {
                list.innerHTML = `<div class="p-10 text-center text-slate-400">لا توجد دروس لهذا الأسبوع</div>`;
                return;
            }

            list.innerHTML = week.days.map(d => `
                <div class="flex items-center p-5 hover:bg-slate-50 transition group">
                    <button onclick="toggleTask('${d.id}')" class="w-8 h-8 rounded-full flex items-center justify-center border-2 transition ${completed.includes(d.id) ? 'bg-teal-500 border-teal-500 text-white' : 'border-slate-200 text-transparent'}">
                        <i data-lucide="check" class="w-5 h-5"></i>
                    </button>
                    <div class="mr-4 flex-grow">
                        <span class="font-bold ${completed.includes(d.id) ? 'text-slate-400 line-through' : 'text-slate-700'}">${d.t}</span>
                    </div>
                    ${d.videoUrl ? `
                        <a href="${d.videoUrl}" target="_blank" class="flex items-center gap-2 text-teal-600 hover:bg-teal-50 px-3 py-1.5 rounded-lg text-xs font-bold transition">
                            <i data-lucide="play-circle" class="w-5 h-5"></i> مشاهدة
                        </a>
                    ` : ''}
                </div>
            `).join('');
            lucide.createIcons();
        }

        function toggleTask(id) {
            completed = completed.includes(id) ? completed.filter(i => i !== id) : [...completed, id];
            localStorage.setItem('edu_pro_done', JSON.stringify(completed));
            renderLessons();
            updateStats();
        }

        function switchWeek(id) {
            activeWeekId = id;
            renderUI();
        }

        function updateStats() {
            const allTasks = config.weeks.flatMap(w => w.days);
            const total = allTasks.length || 0;
            const done = completed.filter(id => allTasks.some(t => t.id === id)).length;
            const remain = total - done;
            const percent = total > 0 ? Math.round((done / total) * 100) : 0;

            document.getElementById('percent-text').innerText = percent + '%';
            document.getElementById('done-count').innerText = done;
            document.getElementById('remain-count').innerText = remain;

            const ctx = document.getElementById('statsChart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [done, remain || (total === 0 ? 1 : 0)],
                        backgroundColor: ['#0d9488', '#f1f5f9'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '85%', plugins: { tooltip: { enabled: false }, legend: { display: false } } }
            });
        }

        function verifyAdmin() {
            const pass = document.getElementById('admin-pass-input').value;
            if (pass === config.adminPassword) {
                document.getElementById('admin-login-area').classList.add('hidden');
                document.getElementById('admin-btn').classList.remove('hidden');
                toggleModal('edit-modal');
            } else {
                alert("كلمة المرور خاطئة");
            }
        }

        function toggleModal(id) {
            const modal = document.getElementById(id);
            modal.classList.toggle('active');
            if (modal.classList.contains('active')) populateAdminPanel();
        }

        function populateAdminPanel() {
            document.getElementById('edit-title').value = config.title;
            document.getElementById('edit-subtitle').value = config.subtitle;
            renderAdminWeeks();
        }

        function renderAdminWeeks() {
            const container = document.getElementById('admin-weeks-container');
            container.innerHTML = config.weeks.map((w, wIdx) => `
                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                    <div class="flex justify-between mb-3">
                        <input type="text" value="${w.title}" onchange="updateWeekTitle(${wIdx}, this.value)" class="font-bold bg-transparent border-b border-slate-300 outline-none w-2/3 focus:border-teal-500">
                        <button onclick="removeWeek(${wIdx})" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <div class="space-y-2">
                        ${w.days.map((d, dIdx) => `
                            <div class="bg-white p-2 rounded-lg border flex flex-col gap-2">
                                <div class="flex gap-2">
                                    <input type="text" value="${d.t}" onchange="updateLesson(${wIdx}, ${dIdx}, 't', this.value)" placeholder="عنوان الدرس" class="flex-grow text-xs border-none outline-none">
                                    <button onclick="removeLesson(${wIdx}, ${dIdx})" class="text-slate-300"><i data-lucide="x" class="w-3 h-3"></i></button>
                                </div>
                                <input type="text" value="${d.videoUrl || ''}" onchange="updateLesson(${wIdx}, ${dIdx}, 'videoUrl', this.value)" placeholder="رابط الفيديو" class="text-[10px] text-teal-600 border-t pt-1 outline-none">
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addLesson(${wIdx})" class="w-full mt-2 py-1 border-2 border-dashed border-slate-200 rounded-lg text-[10px] text-slate-400 font-bold hover:border-teal-300 hover:text-teal-600">+ أضف درساً</button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function updateWeekTitle(idx, val) { config.weeks[idx].title = val; }
        function updateLesson(wIdx, dIdx, field, val) { config.weeks[wIdx].days[dIdx][field] = val; }
        function removeWeek(idx) { config.weeks.splice(idx, 1); renderAdminWeeks(); }
        function removeLesson(wIdx, dIdx) { config.weeks[wIdx].days.splice(dIdx, 1); renderAdminWeeks(); }
        function addNewWeek() { config.weeks.push({ id: Date.now(), title: "أسبوع جديد", days: [] }); renderAdminWeeks(); }
        function addLesson(wIdx) { config.weeks[wIdx].days.push({ id: 'd' + Date.now(), t: "درس جديد", videoUrl: "" }); renderAdminWeeks(); }

        function saveAdminChanges() {
            config.title = document.getElementById('edit-title').value;
            config.subtitle = document.getElementById('edit-subtitle').value;
            localStorage.setItem('edu_pro_config', JSON.stringify(config));
            activeWeekId = config.weeks[0]?.id;
            renderUI();
            updateStats();
            toggleModal('edit-modal');
        }

        function exportData() {
            const dataStr = JSON.stringify(config);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = "curriculum_plan.json";
            link.click();
        }

        function triggerImport() {
            document.getElementById('import-file').click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    config = JSON.parse(e.target.result);
                    localStorage.setItem('edu_pro_config', JSON.stringify(config));
                    activeWeekId = config.weeks[0]?.id;
                    init();
                    alert("تم استيراد الخطة بنجاح!");
                } catch (err) {
                    alert("خطأ في قراءة الملف");
                }
            };
            reader.readAsText(file);
        }

        window.onload = init;
    </script>
</body>
</html>